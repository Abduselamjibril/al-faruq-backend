

services:
  # The NestJS API service for production
  api:
    build:
      context: .
      dockerfile: Dockerfile.prod # Use the optimized production Dockerfile
    container_name: alfaruq_api_prod
    restart: always # Always restart the container if it crashes
    ports:
      # IMPORTANT: We only expose the port internally to Docker.
      # Nginx will handle external access.
      - "5000:5000"
    depends_on:
      - db
    env_file:
      # Load all environment variables from the .env file
      - ./.env
    volumes:
      # Mount the service account key into the container
      # This assumes the key is in the project root on the server
      - ./firebase-service-account.json:/usr/src/app/firebase-service-account.json:ro

  # The PostgreSQL database service
  db:
    image: postgres:15-alpine
    container_name: alfaruq_db_prod
    restart: always
    environment:
      # These variables are loaded from the .env file for consistency
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_DATABASE}
    ports:
      # You can expose this port to the host for direct access if needed for debugging
      # Format: "HOST_PORT:CONTAINER_PORT"
      - "5433:5432"
    volumes:
      # Persist database data on the host machine
      - postgres_data_prod:/var/lib/postgresql/data

# Define a named volume for the database to persist data
volumes:
  postgres_data_prod: